---
#Task for debian based firewall
- name: Remove UFW
  apt:
    name:
    - ufw
    purge: yes
    state: absent
  register: ufw_remove

- name: Disable & Mask UFW
  shell: systemctl stop ufw; systemctl disable ufw; systemctl mask ufw
  when: ufw_remove.changed

- name: Install nftables packages
  apt:
    update_cache: yes
    cache_valid_time: 3600
    name:
    - nftables
    state: latest
  register: nftables_config

- name: Copy default nftables config
  template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
  notify: Restart nftables
  when: ufw_remove.changed or nftables_config.changed

- name: Install fail2ban packages
  apt:
    update_cache: yes
    cache_valid_time: 3600
    name:
    - fail2ban
    state: latest
  register: nftables_config

- name: Change fail2ban service
  lineinfile:
    dest:  /lib/systemd/system/fail2ban.service
    state: present
    regexp: '^PartOf='
    line: 'PartOf=nftables.service'
  notify: Restart fail2ban

- name: Copy default config
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
  notify: Restart fail2ban
